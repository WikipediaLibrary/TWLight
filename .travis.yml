language: python

cache: pip

python:
  - 2.7

addons:
  mariadb: '10.2'

services:
  - mysql

before_install:
  - export DJANGO_SETTINGS_MODULE=TWLight.settings.local
  - export PIP_USE_MIRRORS=true

# Install the dependencies.
install:
  - pip install -r requirements/wmf.txt

# Create databases. Write config file. Ensure static dir exists
before_script:
  - mysql -e "CREATE DATABASE twlight;"
  - mysql -e "GRANT ALL PRIVILEGES on twlight.* to twlight@'%' IDENTIFIED BY 'twlight';"
  - mysql -e "GRANT ALL PRIVILEGES on test_twlight.* to twlight@'%' IDENTIFIED BY 'twlight';"
  - cp TWLight/settings/travis_vars.py TWLight/settings/local_vars.py
  - mkdir -p TWLight/collectedstatic

# Create revisions, make migrations, migrate, sync translations, collect static, test.
script:
  - python manage.py makemigrations
  - python manage.py migrate
  - python manage.py sync_translation_fields --noinput
  - python manage.py collectstatic --noinput --clear
  - python manage.py test --noinput
